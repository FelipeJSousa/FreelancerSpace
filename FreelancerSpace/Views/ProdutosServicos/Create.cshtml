@model FreelancerSpace.Models.ProdutosServicosModel

@{

}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Index</title>
</head>
<body>

    <h4>Produtos e Serviços</h4>
    <hr />
    <div class="row">
        <div class="col-md-4">
            <form>
                <div class="form-group">
                    <div class="form-group">
                        <input id="Id" class="form-control" hidden />
                    </div>
                    <label asp-for="Nome" class="control-label"></label>
                    <input id="txtnome" class="form-control" />
                    <span asp-validation-for="Nome" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="Descricao" class="control-label"></label>
                    <input id="txtdescricao" class="form-control" />
                    <span asp-validation-for="Descricao" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label class="control-label">Ramo Atividade</label>
                    <button id="buscar_cnae" type="button" class="btn" data-toggle="modal" data-target="#Modal">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                            <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
                        </svg>
                        Buscar
                    </button>
                    <input class="form-control" type="text" id="cnae" disabled>
                </div>
                <div class="form-group">
                    <input id="btnsalvar" type="button" value="" class="btn btn-primary" />
                </div>
                <div class="form-group">
                    <div class="col-12">
                        <span id="mensagem" class="alert"></span>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div>
        <a asp-action="Index">Voltar para a lista</a>
    </div>

    <div class="modal fade" id="Modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Tipo</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label for="recipient-name" class="col-form-label">Nome Atividade</label>
                            <input name="Nome" id="descricao" type="text" class="form-control" />
                            <input id="codigo" class="form-control" type="hidden" />
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary fechar" data-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" id="btnadicionar">Adicionar</button>
                </div>
            </div>
        </div>
    </div>
    @section Scripts {
        @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

        <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
        <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/5.5.2/bootbox.min.js"></script>
        <script>
            if (window.location.href.includes("Create/")) {
                document.getElementById("btnsalvar").value = "Editar";
            }
            else {
                document.getElementById("btnsalvar").value = "Salvar";
            }

            function salvarEmpresa() {

                // criar a lista de produtos
                var listaProd = new Array();

                var obj = {
                    id: parseInt($("#Id").val() == "" ? 0 : $("#Id").val()),
                    Nome: $("#txtnome").val(),
                    Descricao: $("#txtdescricao").val(),
                    IdRamoAtividade: $("#codigo").val()
                }
                console.log(JSON.stringify(obj));
                $.ajax({
                    url: "/ProdutosServicos/Salvar",
                    type: "POST",
                    dataType: "json",
                    contentType: 'application/json; charset=UTF-8',
                    data: JSON.stringify(obj),
                    success: function (data) {
                        console.log(data);
                        if (data.status) {
                            $("#mensagem").removeClass('alert-danger').addClass('alert-success').text(data.mensagem);
                            $("#Id").val(data.obj.empCodigo);
                            //limpar
                            $("#Id").val("");
                            $("#txtnome").val("");
                            $("#txtdescricao").val("");
                            $("#cnae").val("");
                            $("#codigo").val("");
                            bootbox.alert(data.mensagem);
                        }
                        else {
                            $("#mensagem").addClass('alert-danger').removeClass('alert-success').text(data.mensagem);
                            bootbox.alert(data.mensagem);
                        }
                    }
                });
            }

            $(document).ready(function () {
                $("#btnsalvar").on('click', function () {
                    $("#mensagem").html("");
                    var validacao = true;
                    var mensagem = "";
                    if ($("#txtnome").val() == "") {
                        validacao = false;
                        mensagem = "Informe nome do Produto/Serviço.";
                    }
                    if ($("#cnae").val() == "") {
                        validacao = false;
                        mensagem = "Informe o Ramo de atividade do Produto/Serviço."
                    }
                    if (validacao) {
                        salvarEmpresa();
                    }
                    else {
                        $("#mensagem").addClass('alert-danger').html(mensagem);
                        bootbox.alert(mensagem);
                    }
                });

                $("#descricao").autocomplete({
                    source: function (request, response) {
                        $.ajax({
                            url: "/Cnae/BuscarAtividade",
                            type: "GET",
                            dataType: "json",
                            data: { nome: request.term },
                            success: function (data) {
                                console.log(data)
                                response($.map(data, (item) => {
                                    return {
                                        label: item.descSubclasse,
                                        value: item.codCnae
                                    };
                                }))
                            }
                        })
                    },
                    minLength: 2,
                    select: function (event, ui) {
                        event.preventDefault();
                        $(this).val(ui.item.label);
                        $("#codigo").val(ui.item.value);
                    },
                    focus: function (event, ui) {
                        event.preventDefault();
                        $("#descricao").val(ui.item.label);
                    }
                });

                $("#btnadicionar").on('click', function () {
                    var cnae, ele;
                    cnae = $("#codigo").val() + "  |  " + $("#descricao").val();
                    ele = document.createElement("p");
                    ele.innerText = cnae;
                    $("#cnae").val(cnae);
                    $("#descricao").val("");
                    $(".modal-backdrop").hide();
                    $("#Modal").modal('hide');
                });
            });
        </script>
    }
</body>
</html>
