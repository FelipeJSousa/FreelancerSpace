@model FreelancerSpace.Models.EmpresaModel

@{
}
<h1>Cadastrar</h1>

<h4>Empresa</h4>
<hr />
<div class="row">
    <form>
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
        <div class="form-group">
            <label asp-for="RazaoSocial" class="control-label"></label>
            <input asp-for="RazaoSocial" class="form-control" />
            <span asp-validation-for="RazaoSocial" class="text-danger"></span>
        </div>
        <div class="form-group">
            <label asp-for="NomeFantasia" class="control-label"></label>
            <input asp-for="NomeFantasia" class="form-control" />
            <span asp-validation-for="NomeFantasia" class="text-danger"></span>
        </div>
        <div class="form-group">
            <label class="control-label">CNAE</label>
            <span>
                <button id="buscar_cnae" type="button" class="btn" data-toggle="modal" data-target="#ModalCnae">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                        <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
                    </svg>
                    Buscar
                </button>
                <input class="form-control" type="text" id="cnae" disabled>
            </span>
            <span asp-validation-for="Cnae" class="text-danger"></span>
        </div>
        <div class="form-group">
            <label asp-for="Cnpj" class="control-label"></label>
            <input asp-for="Cnpj" class="form-control" />
            <span asp-validation-for="Cnpj" class="text-danger"></span>
        </div>
        <div class="form-group">
            <label asp-for="Descricao" class="control-label"></label>
            <input asp-for="Descricao" class="form-control" />
            <span asp-validation-for="Descricao" class="text-danger"></span>
        </div>
        <div class="form-group">
            <label for="txtemail" class="control-label"></label>
            <input type="text" id="txtemail" class="form-control" />
        </div>
        @*<div class="form-group">
                <label asp-for="ImagemDestaque" class="control-label"></label>
                <input asp-for="ImagemDestaque" class="form-control" />
                <span asp-validation-for="ImagemDestaque" class="text-danger"></span>
            </div>*@
        <div>
            <button type="button" class="btn" data-bs-toggle="modal" href="#ModalTelefone"><i class="bi bi-plus"></i>Telefone</button>
            <button type="button" class="btn" data-bs-toggle="modal" href="#ModalEndereco"><i class="bi bi-plus"></i>Endereço</button>
            @*<button type="button" class="btn" data-toggle="modal" data-target="#ModalDisponibilidade"><i class="far fa-plus-square">Disponibilidade</i></button>*@
        </div>
        <div class="form-group">
            <input id="btnsalvar" type="submit" value="" class="btn btn-primary" />
        </div>
    </form>
    <div>
        <a asp-controller="Usuarios" asp-action="Login">Realizar o Login</a>
    </div>


    <div class="modal fade" id="ModalCriaEndereco" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Novo Telefone</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label for="txtcep" class="col-form-label">CEP</label>
                            <input name="txtcep" id="txtcep" type="text" class="form-control" />
                            <span id="spancep"></span>
                        </div>
                        <div class="form-group">
                            <label for="txtrua" class="col-form-label">Rua</label>
                            <input name="txtrua" id="txtrua" type="text" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label for="txtnumero" class="col-form-label">Numero</label>
                            <input name="txtnumero" id="txtnumero" type="text" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label for="txtcomplemento" class="col-form-label">Complemento</label>
                            <input name="txtcomplemento" id="txtcomplemento" type="text" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label for="txtbairro" class="col-form-label">Bairro</label>
                            <input name="txtbairro" id="txtbairro" type="text" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label for="txtcidade" class="col-form-label">Cidade</label>
                            <input name="txtcidade" id="txtcidade" type="text" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label for="txtestado" class="col-form-label">Estado</label>
                            <input name="txtestado" id="txtestado" type="text" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label for="txtsenha">Senha</label>
                            <input name="txtsenha" type="password" class="form-control" id="txtsenha" placeholder="Senha" required>
                        </div>
                        <div class="form-group">
                            <label for="txtconfirmsenha">Confirme a Senha</label>
                            <input name="txtconfirmsenha" type="password" class="form-control" id="txtconfirmsenha" placeholder="Senha" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary fechar" data-bs-target="#ModalEndereco" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" data-bs-target="#ModalEndereco" data-bs-toggle="modal" data-bs-dismiss="modal" id="btnEnderecoadicionar">Adicionar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="ModalEndereco" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Telefones</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div>
                        <button type="button" class="btn" data-bs-toggle="modal" data-bs-target="#ModalCriaEndereco" data-bs-dismiss="modal">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-square" viewBox="0 0 16 16">
                                <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z" />
                                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z" />
                            </svg>
                            Criar Novo
                        </button>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th scope="col">Logradouro</th>
                                <th scope="col">Bairro</th>
                                <th scope="col">Complemento</th>
                                <th scope="col">CEP</th>
                                <th scope="col">Cidade</th>
                                <th scope="col">Estado</th>
                                <th scope="col">Excluir</th>
                            </tr>
                        </thead>
                        <tbody id="tabEnderecos">
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary fechar" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" id="btnEndercosalvar" data-bs-dismiss="modal">Salvar Alterações</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="ModalCriaTelefone" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Novo Telefone</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label for="NumeroTelefone" class="col-form-label">Número Telefone</label>
                            <input name="NumeroTelefone" id="NumeroTelefone" type="text" class="form-control" />
                            <span id="spanTelefone"></span>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary fechar" data-bs-dismiss="modal" data-bs-target="#ModalTelefone">Fechar</button>
                    <button type="button" class="btn btn-primary" data-bs-target="#ModalTelefone" id="btnTelefoneadicionar" data-bs-dismiss="modal">Adicionar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="ModalTelefone" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Telefones</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div>
                        <button type="button" class="btn" data-bs-toggle="modal" data-bs-target="#ModalCriaTelefone" data-bs-dismiss="modal">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-square" viewBox="0 0 16 16">
                                <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z" />
                                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z" />
                            </svg>
                            Criar Novo
                        </button>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th scope="col">Numero</th>
                                <th scope="col">Excluir</th>
                            </tr>
                        </thead>
                        <tbody id="tabTelefones">
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary fechar" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" id="btntelefoneSalvar" data-bs-dismiss="modal">Salvar Alterações</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="ModalCnae" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">CNAE - Busca por Atividade</h5>
                    <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label for="recipient-name" class="col-form-label">Nome Atividade</label>
                            <input name="Nome" id="cnaeDescricao" type="text" class="form-control" />
                            <input id="cnaeCodigo" class="form-control" type="hidden" />
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary fechar" data-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" id="btnCnaeadicionar">Adicionar</button>
                </div>
            </div>
        </div>
    </div>

    @section Scripts {
        @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.maskedinput/1.4.1/jquery.maskedinput.min.js"></script>
        <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
        <script src="~/js/jquery.mask.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/5.5.2/bootbox.min.js"></script>
        <script>
            if (window.location.href.includes("Create/")) {
                document.getElementById("btnsalvar").value = "Editar";
            }
            else {
                document.getElementById("btnsalvar").value = "Salvar";
            }

            function salvarEmpresa() {
                // criar a lista de Telefone
                var listaTelefones = new Array();
                var listaEnderecos = new Array();
                $("#tabTelefones").children().each(function (index, item) {
                    // item
                    var numero = parseInt($(item).find('.numeroTelefone').text());

                    var ing = new Object();
                    ing.Numero = numero;
                    listaTelefones.push(ing);
                });

                $("#tabEnderecos").children().each(function (index, item) {
                    // item
                    var rua = parseInt($(item).find('.ruaEndereco').text());
                    var bairro = parseInt($(item).find('.bairroEndereco').text());
                    var complemento = parseInt($(item).find('.complementoEndereco').text());
                    var cep = parseInt($(item).find('.cepEndereco').text());
                    var cidade = parseInt($(item).find('.cidadeEndereco').text());
                    var estado = parseInt($(item).find('.estadoEndereco').text());

                    var ing = new Object();
                    ing.logradouro = rua;
                    ing.bairro = bairro;
                    ing.complemento = complemento;
                    ing.cep = cep;
                    ing.cidade = cidade;
                    ing.estado = estado;
                    listaEnderecos.push(ing);
                });

                var objEmpresa = {
                    id: parseInt($("#Id").val() == "" ? 0 : $("#Id").val()),
                    RazaoSocial: $("#txtrazaosocial").val(),
                    NomeFantasia: $("#txtnomefantasia").val(),
                    Descricao: $("#txtdescricao").val(),
                    Cnae: $("#cnaeCodigo").val(),
                    Enderecos: listaEnderecos,
                    Telefone: listaTelefones,
                    Username: $("#txtemail").val()
                }
                var objUsuario = {
                    Username: $("#txtemail").val(),
                    Senha: $("#txtsenha").val()
                }
                /*console.log(JSON.stringify(obj));*/
                $.ajax({
                    url: "/Empresa/Salvar",
                    type: "POST",
                    dataType: "json",
                    contentType: 'application/json; charset=UTF-8',
                    data: JSON.stringify(objEmpresa),
                    success: function (data) {
                        console.log(data);
                        if (data.status) {
                            $("#mensagem").removeClass('alert-danger').addClass('alert-success').text(data.mensagem);
                            $("#Id").val(data.obj.Id);
                            //limpar
                            $("#Id").val("");
                            $("#txtnome").val("");
                            $("#txtdescricao").val("");
                            $("#cnae").val("");
                            $("#cnaeCodigo").val("");
                            bootbox.alert(data.mensagem);
                        }
                        else {
                            $("#mensagem").addClass('alert-danger').removeClass('alert-success').text(data.mensagem);
                            bootbox.alert(data.mensagem);
                        }
                    }
                });

                $.ajax({
                    url: "/Usuario/Salvar",
                    type: "POST",
                    dataType: "json",
                    contentType: "application/json; charset=UTF-8",
                    data: JSON.stringify(objUsuario),
                    success: function (data) {
                        console.log(data);
                        if (data.status) {

                        }
                    }
                });
            }


            function excluir(botao) {
                $(botao).parent().parent().remove();
            }

            $(document).ready(function () {
                console.log("Comunicação com Functions.js", soma(1, 2));

                $("#btnEnderecoadicionar").on('click', () => {
                    var logradouro, numero, complemento, cidade, estado, pais;
                    numero = $("#txtnumero").val();
                    logradouro = $("#txtrua").val() + " " + numero;
                    complemento = $("#txtcomplemento").val();
                    cep = $("#txtcep").val();
                    bairro = $("#txtbairro").val();
                    cidade = $("#txtcidade").val();
                    estado = $("#txtestado").val();

                    //validar se já existe
                    
                    
                    //criar linha
                    var linha = $('<tr>');
                    var col1, col2, col3, col4, col5, col6, col7;
                    col1 = $('<td>', { text: logradouro , class: 'ruaEndereco' });
                    col2 = $('<td>', { text: bairro, class: 'bairroEndereco' });
                    col3 = $('<td>', { text: complemento, class: 'complementoEndereco' });
                    col4 = $('<td>', { text: cep, class: 'cepEndereco' });
                    col5 = $('<td>', { text: cidade, class: 'cidadeEndereco' });
                    col6 = $('<td>', { text: estado, class: 'estadoEndereco' });
                    col7 = $('<td>');

                    var button = $("<button>", {
                        class: 'btn btnexcluir',
                        type: 'button',
                        onclick: 'excluir(this)'
                    });
                    col7.append(button);

                    var i = $("<i>", { class: 'bi bi-trash' });
                    button.append(i);

                    linha.append(col1).append(col2).append(col3).append(col4).append(col5).append(col6).append(col7);
                    $("#tabEnderecos").append(linha);

                    //fecha a modal
                    $("#txtrua").val("");
                    $("#txtnumero").val("");
                    $("#txtcomplemento").val("");
                    $("#txtbairro").val("");
                    $("#txtcidade").val("");
                    $("#txtcep").val("");
                    $("#txtestado").val("");
                    $(".modal-backdrop").hide();
                    $("#ModalCriaEndereco").modal('hide');
                })
                
                $('#NumeroTelefone').mask('(00)0000-00000');
                $("#btnTelefoneadicionar").on('click', () => {
                    var numero;
                    $("#spanTelefone").text("");
                    numero = $("#NumeroTelefone").val();

                    //validar se já existe
                    var existe = false;
                    $("#tabTelefones").children().find(".numeroTelefone").each(function (index, ele) {
                        if ($(ele).text() == codigo)
                            existe = true;
                    });

                    //criar linha
                    if (!existe) {
                        if (validarTelefone(numero)) {
                            var linha = $('<tr>');
                            var col1, col2;
                            col1 = $('<td>', { text: numero, class: 'numeroTelefone' });
                            col2 = $('<td>');

                            var button = $("<button>", {
                                class: 'btn btnexcluir',
                                type: 'button',
                                onclick: 'excluir(this)'
                            });
                            col2.append(button);

                            var i = $("<i>", { class: 'bi bi-trash' });
                            button.append(i);

                            linha.append(col1).append(col2);
                            $("#tabTelefones").append(linha);
                             //fecha a modal
                            $("#NumeroTelefone").val("");
                            $(".modal-backdrop").hide();
                            $("#ModalCriaTelefone").modal('hide');
                        }
                        else {
                            $("#spanTelefone").text("O número é inválido!");
                        }
                    }
                    else {
                        $("#spanTelefone").text("Número já foi adicionado!");
                    }
                })


                $("#btnsalvar").on('click', function () {
                    $("#mensagem").html("");
                    var validacao = true;
                    var mensagem = "";
                    if ($("#txtrazaosocial").val() == "") {
                        validacao = false;
                        mensagem = "Informe a Razão Social.";
                    }
                    if ($("#txtnomefantasia").val() == "") {
                        validacao = false;
                        mensagem = "Informe o nome fantasia.";
                    }
                    if ($("#txtcnpj").val() == "") {
                        validacao = false;
                        mensagem = "Informe o CNPJ.";
                    }
                    if ($("#cnae").val() == "") {
                        validacao = false;
                        mensagem = "Informe o CNAE."
                    }
                    if ($("#txtsenha").val() == "") {
                        validacao = false;
                        mensagem = "Informe uma senha."
                    }
                    if ($("#txtconfirmasenha").val() == "") {
                        validacao = false;
                        mensagem = "Confirme a senha."
                    }
                    if ($("#txtemail").val() == "") {
                        validacao = false;
                        mensagem = "Informe o e-mail."
                    }
                    if ($("#tabTelefones").children().length < 1) {
                        validacao = false;
                        mensagem = "Insira pelo menos um telefone."
                    }
                    if ($("#tabEnderecos").children().length < 1) {
                        validacao = false;
                        mensagem = "Insira pelo menos endereço."
                    }

                    if (validacao) {
                        salvarEmpresa();
                    }
                    else {
                        $("#mensagem").addClass('alert-danger').html(mensagem);
                        bootbox.alert(mensagem);
                    }
                });

                $("#cnaeDescricao").autocomplete({
                    source: function (request, response) {
                        $.ajax({
                            url: "/Cnae/BuscarAtividade",
                            type: "GET",
                            dataType: "json",
                            data: { nome: request.term },
                            success: function (data) {
                                console.log(data)
                                response($.map(data, (item) => {
                                    return {
                                        label: item.descSubclasse,
                                        value: item.codCnae
                                    };
                                }))
                            }
                        })
                    },
                    minLength: 2,
                    select: function (event, ui) {
                        event.preventDefault();
                        $(this).val(ui.item.label);
                        $("#cnaeCodigo").val(ui.item.value);
                    },
                    focus: function (event, ui) {
                        event.preventDefault();
                        $("#cnaeDescricao").val(ui.item.label);
                    }
                });

                $("#btnCnaeadicionar").on('click', function () {
                    var cnae, ele;
                    cnae = $("#cnaeCodigo").val() + "  |  " + $("#cnaeDescricao").val();
                    ele = document.createElement("p");
                    ele.innerText = cnae;
                    $("#cnae").val(cnae);
                    $("#cnaeDescricao").val("");
                    $(".modal-backdrop").hide();
                    $("#ModalCnae").modal('hide');
                });

                $("#txtcep").blur(() => {
                    $("#spancep").text("");
                    console.log("focusOut");

                    if ($("#txtcep").val().length == 8) {
                        var url = "https://viacep.com.br/ws/" + $("#txtcep").val() + "/json/";

                        $.getJSON(url, function (data) {
                            console.log(data);
                            var rua = data.logradouro;
                            var bairro = data.bairro;
                            var cidade = data.localidade;
                            var estado = data.uf;
                            var complemento = data.complemento;

                            if (rua != undefined) {
                                $("#txtrua").val(rua);
                                $("#txtbairro").val(bairro);
                                $("#txtcomplemento").val(complemento);
                                $("#txtcidade").val(cidade);
                                $("#txtestado").val(estado);
                            } else {
                                $("#spancep").text("O CEP informado é inexistente");
                            }
                        });
                    } else {
                        $("#spancep").text("O CEP informado é inexistente");
                    }
                });

            });
        </script>
    }



